rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

  function isAuthed() {
    return request.auth != null;
  }

  function isOwner(uid) {
    return isAuthed() && request.auth.uid == uid;
  }

  function isValidUsername(username) {
    return username is string && username.matches('^[a-z0-9._]{3,20}$');
  }

  function isClubMember(clubId) {
    return isAuthed()
      && exists(/databases/$(database)/documents/users/$(request.auth.uid))
      && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.clubId == clubId;
  }
    // Users collection
    match /users/{userId} {
      // Allow users to read and manage their own user document
      allow read, create: if isOwner(userId);
      allow update: if isOwner(userId) && (
        request.resource.data.username == resource.data.username
        || (
          (!("username" in resource.data) || resource.data.username == null || resource.data.username == "")
          && request.resource.data.username is string
          && isValidUsername(request.resource.data.username)
        )
      );
      allow delete: if isAuthed() && isOwner(userId);

      match /friendRequestsOut/{toUid} {
        allow read, create, update: if request.auth != null && request.auth.uid == userId;

        // allow either party to delete, so accept/cancel/cleanup works
        allow delete: if request.auth != null && (request.auth.uid == userId || request.auth.uid == toUid);
      }

      match /friendRequestsIn/{fromUid} {
        // Receiver can read their incoming requests
        allow read: if request.auth != null && request.auth.uid == userId;

        // Sender can create/update ONLY the request doc whose id matches their uid
        allow create, update: if request.auth != null && request.auth.uid == fromUid;

        // Either party can delete (receiver declines OR sender cancels/cleanup)
        allow delete: if request.auth != null && (request.auth.uid == userId || request.auth.uid == fromUid);
      }

      match /friends/{friendUid} {
        allow read: if request.auth != null && request.auth.uid == userId;

        // Allow create/update for owner OR friend accepting request
        allow create, update: if request.auth != null && (
          request.auth.uid == userId ||
          (request.auth.uid == friendUid &&
           exists(/databases/$(database)/documents/users/$(friendUid)/friendRequestsIn/$(userId)))
        );

        // Keep delete as-is (unfriend)
        allow delete: if request.auth != null && (request.auth.uid == userId || request.auth.uid == friendUid);
      }

      match /stats/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      match /achievements/{achievementId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Leaderboards collection - allow authenticated users to read/write
    match /leaderboards/{period} {
      match /entries/{userId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Usernames mapping - lookup by any authenticated user; writes owner-only
    match /usernames/{username} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null
        && request.resource.data.uid == request.auth.uid;
      allow delete: if request.auth != null
        && resource.data.uid == request.auth.uid;
    }

    // Public profiles (collection: publicProfiles) - any authed user can read; owner-only write.
    // When using emulator: restart it after rule changes so it reloads this file.
    match /publicProfiles/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Clubs - create/read by authenticated users; join by querying joinCode
    match /clubs/{clubId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if false;

      match /members/{uid} {
        allow read: if isClubMember(clubId);
        allow create: if isOwner(uid);
        allow update: if isOwner(uid);
        allow delete: if isOwner(uid);
      }
    }

    // Club leaderboards - members can read; users can write their own entry only for their club
    match /clubLeaderboards/{clubId}/entries/{userId} {
      allow read: if isClubMember(clubId);
      allow create, update: if isOwner(userId) && isClubMember(clubId);
      allow delete: if isOwner(userId);
    }
  }
}